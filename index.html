<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Comedor - Lempiras</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        #reader { border: none !important; border-radius: 12px; overflow: hidden; height: 300px; }
        .tab-active { border-bottom: 3px solid #1e40af; color: #1e40af; font-weight: 900; }
        .tab-inactive { color: #94a3b8; }
        .scanner-active { border: 4px solid #fbbf24 !important; }
    </style>
</head>
<body class="p-2 md:p-6">

    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="mb-6 flex flex-col md:flex-row justify-between items-center bg-slate-900 p-6 rounded-xl text-white shadow-xl border-b-4 border-yellow-500">
            <div>
                <h1 class="text-xl font-black uppercase tracking-tighter text-yellow-500">Control de Raciones - Unidad Mil-Com</h1>
                <p class="text-slate-400 text-[10px] font-bold uppercase italic">Moneda Actual: Lempiras (HNL)</p>
            </div>
            <div id="current-time" class="text-xl font-mono font-bold bg-slate-800 px-4 py-2 rounded border border-slate-700 mt-2 md:mt-0">00:00:00</div>
        </header>

        <!-- Navegación -->
        <div class="flex flex-wrap gap-2 mb-6 bg-white p-2 rounded-xl shadow-sm border border-slate-200">
            <button onclick="switchTab('control')" id="nav-control" class="px-4 py-2 text-[10px] uppercase tab-active">Escaner / Control</button>
            <button onclick="switchTab('recarga')" id="nav-recarga" class="px-4 py-2 text-[10px] uppercase tab-inactive">Cargar Lempiras</button>
            <button onclick="switchTab('personal')" id="nav-personal" class="px-4 py-2 text-[10px] uppercase tab-inactive">Suboficiales</button>
            <button onclick="switchTab('reportes')" id="nav-reportes" class="px-4 py-2 text-[10px] uppercase tab-inactive">Historial</button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <!-- COLUMNA IZQUIERDA -->
            <div class="lg:col-span-4 space-y-6">
                <!-- PRECIOS EN LEMPIRAS -->
                <div class="card p-4 border-t-4 border-yellow-500">
                    <h2 class="text-[10px] font-black text-slate-500 mb-3 uppercase tracking-widest">Costos de Ración (L.)</h2>
                    <div class="grid grid-cols-3 gap-2">
                        <div class="text-center p-2 bg-slate-50 rounded border">
                            <p class="text-[8px] font-bold text-gray-400 uppercase">Desayuno</p>
                            <div class="flex items-center justify-center">
                                <span class="text-[10px] font-bold mr-1 text-slate-400">L.</span>
                                <input type="number" id="price-Desayuno" value="50.00" class="w-full font-black text-xs bg-transparent outline-none" onchange="savePrices()">
                            </div>
                        </div>
                        <div class="text-center p-2 bg-slate-50 rounded border">
                            <p class="text-[8px] font-bold text-gray-400 uppercase">Almuerzo</p>
                            <div class="flex items-center justify-center">
                                <span class="text-[10px] font-bold mr-1 text-slate-400">L.</span>
                                <input type="number" id="price-Almuerzo" value="100.00" class="w-full font-black text-xs bg-transparent outline-none" onchange="savePrices()">
                            </div>
                        </div>
                        <div class="text-center p-2 bg-slate-50 rounded border">
                            <p class="text-[8px] font-bold text-gray-400 uppercase">Cena</p>
                            <div class="flex items-center justify-center">
                                <span class="text-[10px] font-bold mr-1 text-slate-400">L.</span>
                                <input type="number" id="price-Cena" value="70.00" class="w-full font-black text-xs bg-transparent outline-none" onchange="savePrices()">
                            </div>
                        </div>
                    </div>
                </div>

                <div id="side-control" class="space-y-6">
                    <!-- SCANNER -->
                    <div class="card p-2 border-t-4 border-blue-600">
                        <div id="reader"></div>
                    </div>

                    <!-- FORMULARIO ACCESO -->
                    <div class="card p-5 border-t-4 border-slate-800">
                        <div class="flex gap-1 mb-4 bg-slate-100 p-1 rounded-lg">
                            <button onclick="setMeal('Desayuno')" id="btn-Desayuno" class="meal-btn flex-1 py-2 rounded font-bold text-[10px] transition-all bg-white shadow text-blue-700">DESAYUNO</button>
                            <button onclick="setMeal('Almuerzo')" id="btn-Almuerzo" class="meal-btn flex-1 py-2 rounded font-bold text-[10px] transition-all text-slate-500">ALMUERZO</button>
                            <button onclick="setMeal('Cena')" id="btn-Cena" class="meal-btn flex-1 py-2 rounded font-bold text-[10px] transition-all text-slate-500">CENA</button>
                        </div>

                        <form id="registro-form" class="space-y-4">
                            <input type="text" id="dni-input" placeholder="DNI / CARNET..." class="w-full p-4 text-xl font-mono font-black rounded-lg border-2 text-center uppercase border-slate-300 outline-none focus:border-blue-600" required>
                            
                            <div id="info-preview" class="hidden p-4 rounded-lg border-2 border-dashed border-blue-200 bg-blue-50/50 text-center">
                                <p id="preview-nombre" class="font-black text-slate-900 text-lg uppercase"></p>
                                <p id="preview-rango" class="text-[10px] text-slate-500 font-bold italic mb-2"></p>
                                <div class="bg-white px-4 py-2 rounded-xl border flex justify-between">
                                    <span class="text-[9px] font-bold text-gray-400 uppercase">Saldo:</span>
                                    <span id="preview-saldo" class="text-sm font-black"></span>
                                </div>
                            </div>

                            <button type="submit" class="w-full bg-slate-900 text-white font-black py-4 rounded-xl shadow-lg uppercase text-[10px] tracking-widest">
                                REGISTRAR MANUALMENTE
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- COLUMNA DERECHA -->
            <div class="lg:col-span-8 space-y-6">
                <!-- VISTA CONTROL -->
                <div id="view-control" class="space-y-6">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="card p-4 border-l-4 border-blue-500"><p class="text-[8px] font-bold text-gray-400 uppercase">D. Hoy</p><p id="stat-desayuno" class="text-xl font-black">0</p></div>
                        <div class="card p-4 border-l-4 border-blue-500"><p class="text-[8px] font-bold text-gray-400 uppercase">A. Hoy</p><p id="stat-almuerzo" class="text-xl font-black">0</p></div>
                        <div class="card p-4 border-l-4 border-green-500"><p class="text-[8px] font-bold text-gray-400 uppercase">Fondo (L.)</p><p id="stat-total" class="text-xl font-black">L. 0</p></div>
                        <div class="card p-4 border-l-4 border-red-500"><p class="text-[8px] font-bold text-gray-400 uppercase">Denegados</p><p id="stat-rechazados" class="text-xl font-black">0</p></div>
                    </div>

                    <div class="card overflow-hidden">
                        <div class="p-4 border-b bg-slate-50 flex justify-between items-center">
                            <h3 class="text-[10px] font-black uppercase italic">Últimos Movimientos</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead class="bg-slate-50 text-[9px] uppercase font-black border-b text-slate-400">
                                    <tr><th class="p-4">Hora</th><th class="p-4">Suboficial</th><th class="p-4">Servicio</th><th class="p-4 text-right">Costo</th><th class="p-4 text-center">Estado</th></tr>
                                </thead>
                                <tbody id="log-body" class="divide-y text-xs"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- VISTA CARGA DE SALDO -->
                <div id="view-recarga" class="hidden space-y-4">
                    <div class="card p-6 border-t-4 border-green-600">
                        <h3 class="font-black text-lg mb-4 uppercase italic">Recarga de Lempiras</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-4">
                                <label class="block text-[10px] font-black uppercase text-slate-500">DNI del Personal</label>
                                <input type="text" id="recarga-dni" class="w-full p-3 border-2 rounded-lg font-bold uppercase" placeholder="BUSCAR DNI...">
                                <input type="number" id="recarga-monto" class="w-full p-3 border-2 rounded-lg font-black text-xl" placeholder="Monto L.">
                            </div>
                            <div class="space-y-4">
                                <label class="block text-[10px] font-black uppercase text-slate-500">Comprobante</label>
                                <div class="border-2 border-dashed border-slate-300 rounded-xl p-6 flex flex-col items-center justify-center bg-slate-50 cursor-pointer" onclick="document.getElementById('file-input').click()">
                                    <span class="text-[10px] font-bold text-slate-500" id="file-name">Subir Captura</span>
                                    <input type="file" id="file-input" class="hidden" accept="image/*" onchange="handleFile(this)">
                                </div>
                                <button onclick="procesarRecarga()" class="w-full bg-green-600 text-white font-black py-4 rounded-xl shadow-lg uppercase text-[10px]">Acreditar Lempiras</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VISTA LISTADO PERSONAL -->
                <div id="view-personal" class="hidden space-y-4">
                    <div class="card p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-black text-lg uppercase italic">Base de Datos</h3>
                            <button onclick="showAddUserModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-[10px] font-black uppercase shadow-lg">Agregar Suboficial</button>
                        </div>
                        <table class="w-full text-left text-xs">
                            <thead class="bg-slate-50 font-black uppercase text-[9px] text-slate-400">
                                <tr><th class="p-3">DNI</th><th class="p-3">Nombre</th><th class="p-3">Rango</th><th class="p-3 text-right">Saldo (L.)</th><th class="p-3">Acciones</th></tr>
                            </thead>
                            <tbody id="user-table-body" class="divide-y"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL NUEVO SUBOFICIAL (CORREGIDO) -->
    <div id="modal-user" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl p-6 max-w-sm w-full shadow-2xl">
            <h3 class="text-xl font-black uppercase mb-4 italic text-blue-900">Nuevo Registro</h3>
            <div class="space-y-4">
                <div>
                    <label class="text-[9px] font-bold text-gray-400 uppercase">DNI / ID Carnet</label>
                    <input type="text" id="new-dni" class="w-full p-3 border-2 rounded-lg font-bold uppercase">
                </div>
                <div>
                    <label class="text-[9px] font-bold text-gray-400 uppercase">Nombre Completo</label>
                    <input type="text" id="new-nombre" class="w-full p-3 border-2 rounded-lg font-bold uppercase">
                </div>
                <div>
                    <label class="text-[9px] font-bold text-gray-400 uppercase">Rango / Grado</label>
                    <input type="text" id="new-rango" class="w-full p-3 border-2 rounded-lg font-bold uppercase">
                </div>
                <div class="flex gap-2 pt-2">
                    <button onclick="document.getElementById('modal-user').classList.add('hidden')" class="flex-1 bg-slate-100 py-3 rounded-xl font-black text-[10px] uppercase">Cancelar</button>
                    <button onclick="saveNewUser()" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-black text-[10px] uppercase">Guardar Registro</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL ALERTA -->
    <div id="modal-alerta" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div id="alert-box" class="bg-white rounded-2xl p-8 max-w-sm w-full text-center shadow-2xl border-t-8">
            <h3 id="modal-titulo" class="text-xl font-black uppercase mb-2"></h3>
            <p id="modal-msg" class="text-slate-600 font-medium mb-6 text-sm"></p>
            <button onclick="document.getElementById('modal-alerta').classList.add('hidden')" class="w-full bg-slate-900 text-white py-3 rounded-xl font-black uppercase text-[10px]">Entendido</button>
        </div>
    </div>

    <script>
        // CONFIGURACIÓN INICIAL
        let PRECIOS = JSON.parse(localStorage.getItem('mil_precios')) || { 'Desayuno': 50, 'Almuerzo': 100, 'Cena': 70 };
        let PADRON = JSON.parse(localStorage.getItem('mil_padron')) || [
            { dni: "60239", nombre: "NOMBRE DE PRUEBA", rango: "SARGENTO", saldo: 250.00 }
        ];
        let registros = JSON.parse(localStorage.getItem('mil_com_regs')) || [];
        
        let mealActual = 'Desayuno';
        let html5QrCode;
        let selectedFileBase64 = null;
        let scanCooldown = false;

        function init() {
            document.getElementById('price-Desayuno').value = PRECIOS.Desayuno;
            document.getElementById('price-Almuerzo').value = PRECIOS.Almuerzo;
            document.getElementById('price-Cena').value = PRECIOS.Cena;
            
            initScanner();
            renderAll();
        }

        // SCANNER (SOPORTA PDF417 DEL CARNET)
        function initScanner() {
            const formats = [
                Html5QrcodeSupportedFormats.QR_CODE,
                Html5QrcodeSupportedFormats.PDF417,
                Html5QrcodeSupportedFormats.CODE_128
            ];
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, 
                { fps: 15, qrbox: { width: 300, height: 150 }, formatsToSupport: formats }, 
                onScanSuccess
            ).catch(err => console.error(err));
        }

        function onScanSuccess(text) {
            if(scanCooldown) return;
            const clean = text.trim().toUpperCase();
            document.getElementById('dni-input').value = clean;
            validarDNI(clean);
            
            const p = PADRON.find(u => u.dni === clean);
            if(p) {
                procesarAcceso(clean);
                activarCooldown();
            }
        }

        function activarCooldown() {
            scanCooldown = true;
            document.getElementById('reader').classList.add('scanner-active');
            setTimeout(() => {
                scanCooldown = false;
                document.getElementById('reader').classList.remove('scanner-active');
            }, 3000);
        }

        // LOGICA DE NEGOCIO
        function validarDNI(val) {
            const p = PADRON.find(u => u.dni === val.toUpperCase());
            const preview = document.getElementById('info-preview');
            if(p) {
                preview.classList.remove('hidden');
                document.getElementById('preview-nombre').innerText = p.nombre;
                document.getElementById('preview-rango').innerText = p.rango;
                document.getElementById('preview-saldo').innerText = `L. ${p.saldo.toFixed(2)}`;
                document.getElementById('preview-saldo').style.color = p.saldo >= PRECIOS[mealActual] ? '#16a34a' : '#dc2626';
            } else {
                preview.classList.add('hidden');
            }
        }

        function procesarAcceso(dni) {
            const p = PADRON.find(u => u.dni === dni);
            const hoy = new Date().toLocaleDateString();
            const costo = PRECIOS[mealActual];

            if(!p) {
                customAlert("No Encontrado", "El suboficial no está registrado en el sistema.", "red");
                return;
            }

            // Validar duplicados
            if(registros.some(r => r.dni === dni && r.fecha === hoy && r.servicio === mealActual && r.estado === 'AUTORIZADO')) {
                customAlert("Denegado", "Ya se registró el consumo de esta ración hoy.", "orange");
                registrarLog(p, 'DUPLICADO', 0);
                return;
            }

            if(p.saldo < costo) {
                customAlert("Saldo Insuficiente", `Necesita L. ${costo}. Saldo actual: L. ${p.saldo.toFixed(2)}`, "red");
                registrarLog(p, 'SIN SALDO', 0);
                return;
            }

            p.saldo -= costo;
            localStorage.setItem('mil_padron', JSON.stringify(PADRON));
            registrarLog(p, 'AUTORIZADO', costo);
            customAlert("Autorizado", `Buen provecho, ${p.rango}.`, "green");
            document.getElementById('dni-input').value = "";
            document.getElementById('info-preview').classList.add('hidden');
        }

        function registrarLog(p, estado, costo) {
            registros.push({
                dni: p.dni, nombre: p.nombre, rango: p.rango, estado, costo,
                servicio: mealActual,
                fecha: new Date().toLocaleDateString(),
                hora: new Date().toLocaleTimeString('es-HN', {hour12:false, hour:'2-digit', minute:'2-digit'})
            });
            localStorage.setItem('mil_com_regs', JSON.stringify(registros));
            renderAll();
        }

        // PERSONAL (REGISTRO CORREGIDO)
        function showAddUserModal() {
            document.getElementById('modal-user').classList.remove('hidden');
        }

        function saveNewUser() {
            const dni = document.getElementById('new-dni').value.trim().toUpperCase();
            const nombre = document.getElementById('new-nombre').value.trim().toUpperCase();
            const rango = document.getElementById('new-rango').value.trim().toUpperCase();

            if(!dni || !nombre) {
                alert("DNI y Nombre son obligatorios");
                return;
            }

            if(PADRON.find(u => u.dni === dni)) {
                alert("Este DNI ya está registrado.");
                return;
            }

            PADRON.push({ dni, nombre, rango, saldo: 0 });
            localStorage.setItem('mil_padron', JSON.stringify(PADRON));
            
            // Limpiar y cerrar
            document.getElementById('new-dni').value = "";
            document.getElementById('new-nombre').value = "";
            document.getElementById('new-rango').value = "";
            document.getElementById('modal-user').classList.add('hidden');
            
            renderUserTable();
            customAlert("Registrado", `${nombre} ha sido agregado con éxito.`, "green");
        }

        function renderUserTable() {
            const body = document.getElementById('user-table-body');
            body.innerHTML = PADRON.map(p => `
                <tr class="hover:bg-slate-50">
                    <td class="p-3 font-mono font-bold">${p.dni}</td>
                    <td class="p-3 font-black uppercase text-blue-900">${p.nombre}</td>
                    <td class="p-3 text-slate-500 font-bold">${p.rango}</td>
                    <td class="p-3 text-right font-black text-green-700">L. ${p.saldo.toFixed(2)}</td>
                    <td class="p-3">
                        <button onclick="eliminarUser('${p.dni}')" class="text-red-500 font-bold uppercase text-[8px] hover:underline">Eliminar</button>
                    </td>
                </tr>
            `).join('');
        }

        function eliminarUser(dni) {
            if(confirm("¿Seguro que desea eliminar este suboficial?")) {
                PADRON = PADRON.filter(u => u.dni !== dni);
                localStorage.setItem('mil_padron', JSON.stringify(PADRON));
                renderUserTable();
            }
        }

        // UI GENERAL
        function renderAll() {
            const hoy = new Date().toLocaleDateString();
            const tbody = document.getElementById('log-body');
            tbody.innerHTML = "";
            let stats = { Desayuno: 0, Almuerzo: 0, Rechazados: 0, Total: 0 };

            PADRON.forEach(p => stats.Total += p.saldo);

            registros.filter(r => r.fecha === hoy).reverse().forEach(r => {
                if(r.estado === 'AUTORIZADO') stats[r.servicio]++;
                else stats.Rechazados++;

                tbody.innerHTML += `
                    <tr>
                        <td class="p-4 opacity-50 font-bold">${r.hora}</td>
                        <td class="p-4 font-black uppercase">${r.nombre}</td>
                        <td class="p-4 font-bold text-slate-400">${r.servicio}</td>
                        <td class="p-4 text-right font-black">L. ${r.costo.toFixed(2)}</td>
                        <td class="p-4 text-center">
                            <span class="px-2 py-1 rounded text-[8px] font-black uppercase ${r.estado === 'AUTORIZADO' ? 'bg-green-600 text-white' : 'bg-red-600 text-white'}">${r.estado}</span>
                        </td>
                    </tr>
                `;
            });

            document.getElementById('stat-desayuno').innerText = stats.Desayuno;
            document.getElementById('stat-almuerzo').innerText = stats.Almuerzo;
            document.getElementById('stat-rechazados').innerText = stats.Rechazados;
            document.getElementById('stat-total').innerText = `L. ${stats.Total.toFixed(2)}`;
        }

        function switchTab(tab) {
            ['control', 'recarga', 'personal', 'reportes'].forEach(t => {
                document.getElementById(`view-${t}`).classList.add('hidden');
                document.getElementById(`nav-${t}`).classList.replace('tab-active', 'tab-inactive');
            });
            document.getElementById(`view-${tab}`).classList.remove('hidden');
            document.getElementById(`nav-${tab}`).classList.replace('tab-inactive', 'tab-active');
            document.getElementById('side-control').classList.toggle('hidden', tab !== 'control');
            if(tab === 'personal') renderUserTable();
        }

        function savePrices() {
            PRECIOS.Desayuno = parseFloat(document.getElementById('price-Desayuno').value) || 0;
            PRECIOS.Almuerzo = parseFloat(document.getElementById('price-Almuerzo').value) || 0;
            PRECIOS.Cena = parseFloat(document.getElementById('price-Cena').value) || 0;
            localStorage.setItem('mil_precios', JSON.stringify(PRECIOS));
        }

        function setMeal(meal) {
            mealActual = meal;
            document.querySelectorAll('.meal-btn').forEach(btn => btn.className = "meal-btn flex-1 py-2 rounded font-bold text-[10px] text-slate-500");
            document.getElementById(`btn-${meal}`).className = "meal-btn flex-1 py-2 rounded font-bold text-[10px] bg-white shadow text-blue-700";
            validarDNI(document.getElementById('dni-input').value);
        }

        function handleFile(input) {
            const file = input.files[0];
            if (file) {
                document.getElementById('file-name').innerText = file.name;
                const reader = new FileReader();
                reader.onload = (e) => selectedFileBase64 = e.target.result;
                reader.readAsDataURL(file);
            }
        }

        function procesarRecarga() {
            const dni = document.getElementById('recarga-dni').value.toUpperCase();
            const monto = parseFloat(document.getElementById('recarga-monto').value);
            const p = PADRON.find(u => u.dni === dni);

            if(!p || isNaN(monto) || monto <= 0 || !selectedFileBase64) {
                alert("Error: Asegúrese de elegir un suboficial registrado, el monto y el comprobante.");
                return;
            }

            p.saldo += monto;
            localStorage.setItem('mil_padron', JSON.stringify(PADRON));
            
            document.getElementById('recarga-dni').value = "";
            document.getElementById('recarga-monto').value = "";
            selectedFileBase64 = null;
            document.getElementById('file-name').innerText = "Subir Captura";
            
            customAlert("Recarga Exitosa", `Se acreditaron L. ${monto.toFixed(2)} a ${p.nombre}`, "green");
            renderAll();
        }

        function customAlert(titulo, msg, color) {
            const modal = document.getElementById('modal-alerta');
            modal.classList.remove('hidden');
            const colorHex = color === 'red' ? '#dc2626' : (color === 'orange' ? '#ea580c' : '#16a34a');
            document.getElementById('alert-box').style.borderColor = colorHex;
            document.getElementById('modal-titulo').innerText = titulo;
            document.getElementById('modal-titulo').style.color = colorHex;
            document.getElementById('modal-msg').innerText = msg;
        }

        document.getElementById('registro-form').addEventListener('submit', (e) => {
            e.preventDefault();
            procesarAcceso(document.getElementById('dni-input').value.toUpperCase());
        });

        setInterval(() => {
            document.getElementById('current-time').innerText = new Date().toLocaleTimeString('es-HN', {hour12:false});
        }, 1000);

        window.onload = init;
    </script>
</body>
</html>
