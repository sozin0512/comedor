<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIL-COM V14 | Gestión de Saldo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBwaRzw2R1DCFOSn-YtfM5tRLdN7p4dpk8",
            authDomain: "comedor-86278.firebaseapp.com",
            projectId: "comedor-86278",
            storageBucket: "comedor-86278.firebasestorage.app",
            messagingSenderId: "1081425728323",
            appId: "1:1081425728323:web:f7fabcacc19a8f0daf15f6"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = "comedor-86278";

        const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'config', 'mainState');

        window.STATE = {
            prices: { Desayuno: 50, Almuerzo: 100, Cena: 70 },
            users: [],
            history: [],
            votes: [],
            menu: {
                Desayuno: ["Baleadas Mixtas", "Huevo con Jamón", "Panqueques"],
                Almuerzo: ["Pollo Frito", "Carne Asada", "Pescado"],
                Cena: ["Tacos Mexicanos", "Sopa de Frijol", "Pasta Alfredo"]
            }
        };

        async function startSync() {
            try {
                await signInAnonymously(auth);
                onSnapshot(docRef, (snapshot) => {
                    if (snapshot.exists()) {
                        window.STATE = { ...window.STATE, ...snapshot.data() };
                        renderAll();
                        if (window.activeTab === 'vote') syncVoteUI();
                    } else {
                        setDoc(docRef, window.STATE);
                    }
                });
            } catch (error) {
                console.error("Firebase Auth Error:", error.message);
            }
        }

        window.saveToCloud = async () => {
            if (!auth.currentUser) return;
            await setDoc(docRef, window.STATE).catch(e => console.error("Error al guardar:", e));
        };

        window.onload = () => {
            startSync();
            initClock();
            startScanner();
        };

        window.renderAll = renderAll;
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap');
        :root { --primary: #f2994a; --bg-dark: #0d1117; --card-dark: #161b22; --border-dark: #30363d; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-dark); color: #e2e8f0; overflow-x: hidden; }
        .card { background: var(--card-dark); border: 1px solid var(--border-dark); border-radius: 16px; }
        .btn-active { background-color: var(--primary) !important; color: #000 !important; }
        .tab-btn-active { border-bottom: 4px solid var(--primary); color: var(--primary); background: rgba(242, 153, 74, 0.08); }
        .vote-opt-btn.selected { border-color: var(--primary); background: rgba(242, 153, 74, 0.2); }
        .hidden { display: none; }
    </style>
</head>
<body class="p-4 md:p-8">

<div class="max-w-7xl mx-auto space-y-6">
    <!-- HEADER -->
    <header class="card p-6 flex flex-col md:flex-row justify-between items-center border-b-4 border-orange-500 shadow-2xl">
        <div class="flex items-center gap-5">
            <div class="p-3 bg-orange-500/10 rounded-2xl border border-orange-500/20">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-orange-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            </div>
            <div>
                <h1 class="text-2xl font-black uppercase italic">MIL-COM <span class="text-orange-500">V14</span></h1>
                <p id="logged-name" class="text-[10px] font-bold text-slate-500 uppercase italic">Esperando identificación...</p>
            </div>
        </div>
        <div class="text-right">
            <div id="clock" class="text-3xl font-mono font-black text-orange-500">00:00:00</div>
            <p id="today-date" class="text-[10px] font-bold text-slate-500 uppercase"></p>
        </div>
    </header>

    <!-- NAVIGATION -->
    <nav class="flex bg-[#161b22] rounded-2xl border border-[#30363d] overflow-hidden p-1 gap-1">
        <button onclick="changeTab('scan')" id="tab-scan" class="flex-1 py-3 text-[10px] font-black uppercase rounded-xl tab-btn-active">Escaneo</button>
        <button onclick="changeTab('vote')" id="tab-vote" class="flex-1 py-3 text-[10px] font-black uppercase rounded-xl text-slate-500">Votación</button>
        <button onclick="changeTab('users')" id="tab-users" class="flex-1 py-3 text-[10px] font-black uppercase rounded-xl text-slate-500">Personal</button>
        <button onclick="changeTab('settings')" id="tab-settings" class="flex-1 py-3 text-[10px] font-black uppercase rounded-xl text-slate-500">Ajustes</button>
    </nav>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
        <!-- COLUMNA ESCANER -->
        <div class="lg:col-span-4">
            <div class="card p-5 sticky top-6 space-y-4">
                <div id="reader" class="w-full aspect-square bg-black rounded-xl overflow-hidden border border-[#30363d]"></div>
                <div class="p-4 bg-black/40 rounded-xl border border-dashed border-[#30363d] text-center">
                    <p id="dni-display" class="text-3xl font-mono text-orange-500 font-black">---</p>
                </div>
                <input type="text" id="quick-dni" placeholder="ID MANUAL + ENTER" 
                       onkeypress="if(event.key === 'Enter') handleScan(this.value.toUpperCase())"
                       class="w-full bg-black border border-[#30363d] p-3 rounded-xl text-center font-mono text-sm text-orange-400">
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="openManualReg()" class="bg-blue-600/10 text-blue-500 py-3 rounded-xl text-[10px] font-black uppercase">Nuevo</button>
                    <button onclick="logout()" class="bg-red-500/10 text-red-500 py-3 rounded-xl text-[10px] font-black uppercase">Cerrar</button>
                </div>
            </div>
        </div>

        <!-- COLUMNA PRINCIPAL -->
        <div class="lg:col-span-8">
            <!-- VIEW: SCAN -->
            <div id="view-scan" class="space-y-6">
                <div class="card p-6">
                    <div class="grid grid-cols-3 gap-3">
                        <button onclick="setService('Desayuno')" id="svc-Desayuno" class="svc-btn py-4 text-[10px] font-black rounded-xl border border-[#30363d] btn-active">DESAYUNO</button>
                        <button onclick="setService('Almuerzo')" id="svc-Almuerzo" class="svc-btn py-4 text-[10px] font-black rounded-xl border border-[#30363d] text-slate-400">ALMUERZO</button>
                        <button onclick="setService('Cena')" id="svc-Cena" class="svc-btn py-4 text-[10px] font-black rounded-xl border border-[#30363d] text-slate-400">CENA</button>
                    </div>
                </div>
                <div class="card overflow-hidden">
                    <div class="p-4 bg-white/5 font-black uppercase text-[10px] italic border-b border-[#30363d]">Actividad Reciente</div>
                    <div class="max-h-[400px] overflow-y-auto">
                        <table class="w-full text-left text-xs">
                            <tbody id="history-body" class="divide-y divide-[#30363d]"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- VIEW: VOTE -->
            <div id="view-vote" class="hidden card p-6 space-y-6">
                <div class="flex justify-between items-end">
                    <h2 class="text-xl font-black uppercase italic text-orange-500">Encuesta de Menú</h2>
                    <p id="total-voters-count" class="text-xs font-bold text-slate-500 uppercase">0 Votos</p>
                </div>
                <div id="vote-container" class="opacity-30 pointer-events-none space-y-6">
                    <div id="vote-options-grid" class="space-y-4"></div>
                    <button onclick="submitVotes()" class="w-full bg-orange-500 text-black py-4 rounded-xl font-black uppercase">Confirmar Selección</button>
                </div>
            </div>

            <!-- VIEW: USERS (RECARGAS AQUÍ) -->
            <div id="view-users" class="hidden card p-4">
                <input type="text" id="user-search" oninput="renderAll()" placeholder="Filtrar por nombre o ID..." class="w-full bg-black border border-[#30363d] p-4 rounded-xl text-xs font-bold mb-4 outline-none focus:border-orange-500">
                <div class="max-h-[500px] overflow-y-auto">
                    <table class="w-full text-xs text-left">
                        <thead class="bg-black text-slate-500 font-black uppercase text-[9px]">
                            <tr>
                                <th class="p-4">Identidad</th>
                                <th class="p-4">Nombre Completo</th>
                                <th class="p-4 text-center">Saldo Actual</th>
                                <th class="p-4 text-center">Gestión</th>
                            </tr>
                        </thead>
                        <tbody id="users-body" class="divide-y divide-[#30363d]"></tbody>
                    </table>
                </div>
            </div>

            <!-- VIEW: SETTINGS -->
            <div id="view-settings" class="hidden card p-8 space-y-6">
                <h3 class="text-lg font-black uppercase italic text-orange-500 border-b border-[#30363d] pb-4">Ajustes del Sistema</h3>
                <div class="grid grid-cols-3 gap-4">
                    <div class="space-y-2">
                        <label class="text-[9px] font-black uppercase text-slate-500">Precio Desayuno</label>
                        <input type="number" id="set-p-des" class="w-full bg-black border border-[#30363d] p-3 rounded-xl font-bold text-orange-500">
                    </div>
                    <div class="space-y-2">
                        <label class="text-[9px] font-black uppercase text-slate-500">Precio Almuerzo</label>
                        <input type="number" id="set-p-alm" class="w-full bg-black border border-[#30363d] p-3 rounded-xl font-bold text-orange-500">
                    </div>
                    <div class="space-y-2">
                        <label class="text-[9px] font-black uppercase text-slate-500">Precio Cena</label>
                        <input type="number" id="set-p-cen" class="w-full bg-black border border-[#30363d] p-3 rounded-xl font-bold text-orange-500">
                    </div>
                </div>
                <div id="settings-menu-editor" class="space-y-4 pt-4 border-t border-[#30363d]"></div>
                <button onclick="saveSettings()" class="w-full bg-blue-600 py-4 rounded-xl font-black uppercase">Guardar Configuración</button>
            </div>
        </div>
    </div>
</div>
<!-- MODALES -->
<div id="login-modal" class="hidden fixed inset-0 bg-black/95 z-[100] flex items-center justify-center p-4">
    <div class="card max-w-sm w-full p-8 text-center space-y-6">
        <h3 class="text-xl font-black italic">ADMIN PIN</h3>
        <input type="password" id="admin-pin" class="w-full bg-black border border-orange-500 p-4 rounded-xl text-center text-4xl tracking-[0.5em] outline-none">
        <button onclick="checkAdmin()" class="w-full bg-white text-black py-4 rounded-xl font-black">ENTRAR</button>
    </div>
</div>

<div id="reg-modal" class="hidden fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4">
    <div class="card max-w-sm w-full p-8">
        <h3 class="text-xl font-black uppercase text-center mb-6">Nuevo Personal</h3>
        <div class="space-y-4">
            <input type="text" id="nu-dni" placeholder="ID / DNI" class="w-full bg-black border border-[#30363d] p-4 rounded-xl font-mono text-orange-500 text-center uppercase">
            <input type="text" id="nu-name" placeholder="NOMBRE COMPLETO" class="w-full bg-black border border-[#30363d] p-4 rounded-xl font-bold uppercase">
            <button onclick="saveNewUser()" class="w-full bg-orange-500 text-black py-4 rounded-xl font-black">CREAR CUENTA</button>
            <button onclick="document.getElementById('reg-modal').classList.add('hidden')" class="w-full text-slate-500 text-[10px] font-black uppercase">Cancelar</button>
        </div>
    </div>
</div>

<div id="toast" class="hidden fixed bottom-6 right-6 z-[200] p-6 rounded-2xl border-l-8 bg-[#1a202c] shadow-2xl min-w-[300px]">
    <h4 id="toast-title" class="font-black uppercase text-sm mb-1"></h4>
    <p id="toast-msg" class="text-[11px] font-bold opacity-70"></p>
</div>

<script>
    const PIN_ADMIN = "1234";
    let charts = {};
    let currentSvc = 'Desayuno';
    let loggedUser = null; 
    let scanner = null;
    window.activeTab = 'scan';

    function initClock() {
        setInterval(() => document.getElementById('clock').innerText = new Date().toLocaleTimeString('es-HN', { hour12: false }), 1000);
        document.getElementById('today-date').innerText = new Date().toLocaleDateString('es-HN', { weekday: 'long', day: 'numeric', month: 'long' });
    }

    function startScanner() {
        scanner = new Html5Qrcode("reader");
        scanner.start({ facingMode: "environment" }, { fps: 30, qrbox: 250 }, (text) => handleScan(text.trim().toUpperCase())).catch(() => {});
    }

    window.handleScan = (dni) => {
        if(!dni) return;
        const user = STATE.users.find(u => u.dni === dni);
        if (user) {
            loggedUser = user;
            document.getElementById('dni-display').innerText = dni;
            document.getElementById('logged-name').innerText = user.name;
            document.getElementById('logged-name').classList.add('text-green-500');
            if (window.activeTab === 'scan') processMeal(user);
            if (window.activeTab === 'vote') syncVoteUI();
        } else {
            openManualReg(dni);
        }
    };

    function processMeal(user) {
        const cost = STATE.prices[currentSvc];
        const today = new Date().toLocaleDateString();
        if (user.balance < cost) { notify("SALDO INSUFICIENTE", "SALDO: L. " + user.balance, "error"); return; }
        user.balance -= cost;
        STATE.history.unshift({ dni: user.dni, name: user.name, svc: currentSvc, date: today, price: cost });
        saveToCloud();
        renderAll();
        notify("REGISTRO EXITOSO", `${user.name} consumió ${currentSvc} - L.${cost}`, "success");
    }

    window.changeTab = (tab) => {
        window.activeTab = tab;
        ['scan','vote','users','settings'].forEach(t => document.getElementById('view-'+t).classList.add('hidden'));
        document.getElementById('view-'+tab).classList.remove('hidden');
        ['tab-scan','tab-vote','tab-users','tab-settings'].forEach(id => document.getElementById(id).classList.remove('tab-btn-active'));
        document.getElementById('tab-'+tab).classList.add('tab-btn-active');
        if(tab === 'vote') syncVoteUI();
        renderAll();
    };

    window.setService = (svc) => {
        currentSvc = svc;
        document.querySelectorAll('.svc-btn').forEach(b => b.classList.remove('btn-active', 'text-slate-400'));
        document.getElementById('svc-'+svc).classList.add('btn-active');
        renderAll();
        if(window.activeTab === 'vote') syncVoteUI();
    };

    window.renderAll = () => {
        // Render history
        const histBody = document.getElementById('history-body');
        histBody.innerHTML = STATE.history.map(h => `<tr class="text-[10px]"><td class="p-2">${h.date}</td><td class="p-2">${h.name}</td><td class="p-2">${h.svc}</td><td class="p-2 text-right">L.${h.price}</td></tr>`).join('');
        // Users
        const search = document.getElementById('user-search')?.value.toUpperCase() || '';
        const usersBody = document.getElementById('users-body');
        if(usersBody){
            usersBody.innerHTML = STATE.users.filter(u => u.name.toUpperCase().includes(search) || u.dni.includes(search))
            .map(u => `<tr class="text-[10px]">
                <td class="p-2">${u.dni}</td>
                <td class="p-2">${u.name}</td>
                <td class="p-2 text-center">L.${u.balance}</td>
                <td class="p-2 text-center space-x-2">
                    <button onclick="creditUser('${u.dni}')" class="text-green-500 font-black text-[10px]">+RECARGA</button>
                    <button onclick="deleteUser('${u.dni}')" class="text-red-500 font-black text-[10px]">BORRAR</button>
                </td>
            </tr>`).join('');
        }
        // Votantes
        document.getElementById('total-voters-count').innerText = `${STATE.votes.length} Votos`;
    };

    window.creditUser = (dni) => {
        const amt = prompt("Monto a recargar:");
        if(!amt) return;
        const user = STATE.users.find(u=>u.dni===dni);
        if(user){ user.balance += parseFloat(amt); saveToCloud(); renderAll(); }
    };

    // Función para borrar usuario
    window.deleteUser = (dni) => {
        const user = STATE.users.find(u => u.dni === dni);
        if(!user) return;
        if(confirm(`¿Deseas eliminar al usuario ${user.name} (${dni})? Esta acción no se puede deshacer.`)){
            STATE.users = STATE.users.filter(u => u.dni !== dni);
            saveToCloud();
            renderAll();
            notify("USUARIO ELIMINADO", `${user.name} ha sido eliminado`, "success");
        }
    };

    function openManualReg(dni='') {
        document.getElementById('nu-dni').value = dni;
        document.getElementById('nu-name').value = '';
        document.getElementById('reg-modal').classList.remove('hidden');
    }

    function saveNewUser() {
        const dni = document.getElementById('nu-dni').value.toUpperCase();
        const name = document.getElementById('nu-name').value.toUpperCase();
        if(!dni || !name){ alert("Completa los campos"); return; }
        STATE.users.push({ dni, name, balance: 0 });
        saveToCloud();
        document.getElementById('reg-modal').classList.add('hidden');
        renderAll();
    }

    function logout() {
        loggedUser = null;
        document.getElementById('dni-display').innerText = '---';
        document.getElementById('logged-name').innerText = 'Esperando identificación...';
        document.getElementById('logged-name').classList.remove('text-green-500');
    }

    window.notify = (title,msg,type="info") => {
        const toast = document.getElementById('toast');
        document.getElementById('toast-title').innerText = title;
        document.getElementById('toast-msg').innerText = msg;
        toast.classList.remove('hidden');
        setTimeout(()=>toast.classList.add('hidden'),3000);
    };

    // Votación dinámica
    window.syncVoteUI = () => {
        if(!loggedUser) return;
        const container = document.getElementById('vote-options-grid');
        container.innerHTML = "";
        const comidas = STATE.menu[currentSvc] || [];
        comidas.forEach(c => {
            const btn = document.createElement('button');
            btn.className = "vote-opt-btn w-full py-3 rounded-xl border border-[#30363d] text-slate-200 font-black uppercase text-[10px]";
            btn.innerText = c;
            btn.onclick = () => {
                container.querySelectorAll('.vote-opt-btn').forEach(b=>b.classList.remove('selected'));
                btn.classList.add('selected');
            };
            container.appendChild(btn);
        });
        container.parentElement.classList.remove('opacity-30','pointer-events-none');
    };

    window.submitVotes = () => {
        const selected = document.querySelector('.vote-opt-btn.selected');
        if(!selected){ alert("Selecciona una opción"); return; }
        const choice = selected.innerText;
        STATE.votes.push({ dni: loggedUser.dni, name: loggedUser.name, svc: currentSvc, vote: choice, date: new Date().toLocaleDateString() });
        saveToCloud();
        notify("VOTO REGISTRADO", `Has votado por "${choice}"`, "success");
        syncVoteUI();
    };

    function saveSettings() {
        const des = parseFloat(document.getElementById('set-p-des').value);
        const alm = parseFloat(document.getElementById('set-p-alm').value);
        const cen = parseFloat(document.getElementById('set-p-cen').value);
        if(!isNaN(des)) STATE.prices.Desayuno = des;
        if(!isNaN(alm)) STATE.prices.Almuerzo = alm;
        if(!isNaN(cen)) STATE.prices.Cena = cen;
        saveToCloud();
        notify("CONFIGURACIÓN GUARDADA","Precios actualizados correctamente","success");
    }
</script>

</body>
</html>
