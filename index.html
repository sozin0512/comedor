<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Comedor y Pagos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .input-focus:focus { border-color: #1e40af; box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1); outline: none; }
        #reader { border: none !important; border-radius: 12px; overflow: hidden; height: 300px; }
        .tab-active { border-bottom: 3px solid #1e40af; color: #1e40af; font-weight: 900; }
        .tab-inactive { color: #94a3b8; }
        .scanner-active { border: 4px solid #fbbf24 !important; }
    </style>
</head>
<body class="p-2 md:p-6">

    <div class="max-w-7xl mx-auto">
        <!-- Header Principal -->
        <header class="mb-6 flex flex-col md:flex-row justify-between items-center bg-slate-900 p-6 rounded-xl text-white shadow-xl border-b-4 border-yellow-500">
            <div>
                <h1 class="text-xl font-black uppercase tracking-tighter text-yellow-500">Sistema de Control Biográfico y Financiero</h1>
                <p class="text-slate-400 text-xs font-bold uppercase italic text-gray-500">Unidad Mil-Com - Gestión de Identidades y Raciones</p>
            </div>
            <div id="current-time" class="text-xl font-mono font-bold bg-slate-800 px-4 py-2 rounded border border-slate-700 mt-2 md:mt-0">00:00:00</div>
        </header>

        <!-- Navegación Principal -->
        <div class="flex flex-wrap gap-2 mb-6 bg-white p-2 rounded-xl shadow-sm border border-slate-200">
            <button onclick="switchTab('control')" id="nav-control" class="px-4 py-2 text-xs uppercase tab-active">Control de Acceso</button>
            <button onclick="switchTab('recarga')" id="nav-recarga" class="px-4 py-2 text-xs uppercase tab-inactive">Cargar Saldo</button>
            <button onclick="switchTab('personal')" id="nav-personal" class="px-4 py-2 text-xs uppercase tab-inactive">Base de Suboficiales</button>
            <button onclick="switchTab('reportes')" id="nav-reportes" class="px-4 py-2 text-xs uppercase tab-inactive">Historial Diario</button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <!-- COLUMNA IZQUIERDA: CONFIGURACIÓN Y SCANNER -->
            <div class="lg:col-span-4 space-y-6">
                
                <!-- PRECIOS -->
                <div class="card p-4 border-t-4 border-yellow-500">
                    <h2 class="text-[10px] font-black text-slate-500 mb-3 uppercase tracking-widest">Ajuste de Precios</h2>
                    <div class="grid grid-cols-3 gap-2">
                        <div class="text-center p-2 bg-slate-50 rounded border">
                            <p class="text-[8px] font-bold text-gray-400 uppercase">Desayuno</p>
                            <input type="number" id="price-Desayuno" value="5.00" class="w-full text-center font-black text-xs bg-transparent outline-none" onchange="savePrices()">
                        </div>
                        <div class="text-center p-2 bg-slate-50 rounded border">
                            <p class="text-[8px] font-bold text-gray-400 uppercase">Almuerzo</p>
                            <input type="number" id="price-Almuerzo" value="10.00" class="w-full text-center font-black text-xs bg-transparent outline-none" onchange="savePrices()">
                        </div>
                        <div class="text-center p-2 bg-slate-50 rounded border">
                            <p class="text-[8px] font-bold text-gray-400 uppercase">Cena</p>
                            <input type="number" id="price-Cena" value="7.00" class="w-full text-center font-black text-xs bg-transparent outline-none" onchange="savePrices()">
                        </div>
                    </div>
                </div>

                <!-- SCANNER & ACCESO -->
                <div id="side-control" class="space-y-6">
                    <div class="card p-2 border-t-4 border-blue-600 relative">
                        <div id="reader"></div>
                        <div class="absolute top-4 right-4 z-10">
                            <span class="bg-blue-600 text-white text-[8px] font-bold px-2 py-1 rounded-full uppercase animate-pulse">Escaner Activo</span>
                        </div>
                    </div>

                    <div class="card p-5 border-t-4 border-slate-800">
                        <div class="flex gap-1 mb-4 bg-slate-100 p-1 rounded-lg">
                            <button onclick="setMeal('Desayuno')" id="btn-Desayuno" class="meal-btn flex-1 py-2 rounded font-bold text-[10px] transition-all bg-white shadow text-blue-700">DESAYUNO</button>
                            <button onclick="setMeal('Almuerzo')" id="btn-Almuerzo" class="meal-btn flex-1 py-2 rounded font-bold text-[10px] transition-all text-slate-500">ALMUERZO</button>
                            <button onclick="setMeal('Cena')" id="btn-Cena" class="meal-btn flex-1 py-2 rounded font-bold text-[10px] transition-all text-slate-500">CENA</button>
                        </div>

                        <form id="registro-form" class="space-y-4">
                            <div class="relative">
                                <input type="text" id="dni-input" placeholder="DNI O ESCANEO DE CARNET..." class="w-full p-4 text-xl font-mono font-black rounded-lg border-2 input-focus text-center uppercase border-slate-300" required>
                                <div class="text-center mt-2">
                                    <span class="text-[9px] text-slate-400 font-bold uppercase italic">Detecta PDF417, QR y Códigos de Barras</span>
                                </div>
                            </div>
                            
                            <div id="info-preview" class="hidden p-4 rounded-lg border-2 border-dashed border-blue-200 bg-blue-50/50 flex flex-col items-center text-center">
                                <p id="preview-nombre" class="font-black text-slate-900 text-lg uppercase"></p>
                                <p id="preview-rango" class="text-[10px] text-slate-500 font-bold mb-2 italic"></p>
                                <div class="bg-white px-4 py-2 rounded-xl border shadow-sm w-full">
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="text-[9px] font-bold text-gray-400 uppercase">Saldo Actual:</span>
                                        <span id="preview-saldo" class="text-sm font-black"></span>
                                    </div>
                                    <div class="flex justify-between items-center pt-1 border-t border-slate-100">
                                        <span class="text-[9px] font-bold text-gray-400 uppercase">Costo Servicio:</span>
                                        <span id="preview-costo-actual" class="text-sm font-black text-blue-600"></span>
                                    </div>
                                </div>
                            </div>

                            <button type="submit" class="w-full bg-slate-900 hover:bg-black text-white font-black py-4 rounded-xl shadow-lg transition-all active:scale-95 uppercase text-xs tracking-widest">
                                REGISTRAR ACCESO MANUAL
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- COLUMNA DERECHA: TABLAS Y DATOS -->
            <div class="lg:col-span-8 space-y-6">
                
                <!-- SECCIÓN 1: MONITOREO / CONTROL -->
                <div id="view-control" class="space-y-6">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="card p-4 border-l-4 border-blue-500"><p class="text-[8px] font-bold text-gray-400 uppercase">Desayunos Hoy</p><p id="stat-desayuno" class="text-xl font-black">0</p></div>
                        <div class="card p-4 border-l-4 border-blue-500"><p class="text-[8px] font-bold text-gray-400 uppercase">Almuerzos Hoy</p><p id="stat-almuerzo" class="text-xl font-black">0</p></div>
                        <div class="card p-4 border-l-4 border-green-500"><p class="text-[8px] font-bold text-gray-400 uppercase">Fondo Total</p><p id="stat-total" class="text-xl font-black">$0</p></div>
                        <div class="card p-4 border-l-4 border-red-500"><p class="text-[8px] font-bold text-gray-400 uppercase">Denegados</p><p id="stat-rechazados" class="text-xl font-black">0</p></div>
                    </div>

                    <div class="card overflow-hidden">
                        <div class="p-4 border-b bg-slate-50 flex justify-between items-center">
                            <h3 class="text-xs font-black uppercase italic">Movimientos de Hoy</h3>
                            <span id="label-fecha" class="text-[10px] font-bold text-slate-500"></span>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead class="bg-slate-50 text-slate-500 text-[9px] uppercase font-black border-b">
                                    <tr><th class="p-4">Hora</th><th class="p-4">Personal</th><th class="p-4">Servicio</th><th class="p-4 text-right">Costo</th><th class="p-4 text-center">Estado</th></tr>
                                </thead>
                                <tbody id="log-body" class="divide-y text-xs"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- SECCIÓN 2: CARGAR SALDO -->
                <div id="view-recarga" class="hidden space-y-4">
                    <div class="card p-6 border-t-4 border-green-600">
                        <h3 class="font-black text-lg mb-4 text-slate-800 uppercase italic">Registro de Fondos</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-4">
                                <label class="block text-[10px] font-black uppercase text-slate-500">1. Buscar Suboficial (DNI)</label>
                                <input type="text" id="recarga-dni" class="w-full p-3 border-2 rounded-lg font-mono font-bold border-slate-200 uppercase" placeholder="DNI...">
                                <div id="recarga-persona-info" class="mt-2 text-xs font-bold text-green-700 p-2 bg-green-50 rounded border border-green-200 hidden"></div>
                                <input type="number" id="recarga-monto" class="w-full p-3 border-2 rounded-lg font-black text-xl border-slate-200" placeholder="Monto $0.00">
                            </div>
                            <div class="space-y-4">
                                <label class="block text-[10px] font-black uppercase text-slate-500">2. Comprobante</label>
                                <div class="border-2 border-dashed border-slate-300 rounded-xl p-4 flex flex-col items-center justify-center bg-slate-50 cursor-pointer" onclick="document.getElementById('file-input').click()">
                                    <span class="text-[10px] font-bold text-slate-500" id="file-name">Subir Imagen</span>
                                    <input type="file" id="file-input" class="hidden" accept="image/*" onchange="handleFile(this)">
                                </div>
                                <button onclick="procesarRecarga()" class="w-full bg-green-600 text-white font-black py-4 rounded-xl shadow-lg uppercase text-xs">Acreditar Saldo</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SECCIÓN 3: BASE DE SUBOFICIALES -->
                <div id="view-personal" class="hidden space-y-4">
                    <div class="card p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-black text-lg uppercase italic">Registro de Suboficiales</h3>
                            <button onclick="showAddUserModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-[10px] font-black uppercase">Nuevo Registro</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-xs">
                                <thead class="bg-slate-50 font-black uppercase text-[9px]">
                                    <tr><th class="p-3">DNI</th><th class="p-3">Nombre Completo</th><th class="p-3">Rango</th><th class="p-3 text-right">Saldo Actual</th><th class="p-3">Acciones</th></tr>
                                </thead>
                                <tbody id="user-table-body" class="divide-y"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- SECCIÓN 4: REPORTES -->
                <div id="view-reportes" class="hidden space-y-4">
                    <div class="card p-6">
                        <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-4">
                            <h3 class="font-black text-lg uppercase italic text-blue-900">Historial de Raciones</h3>
                            <input type="date" id="filter-date" onchange="renderReporte()" class="p-2 border-2 rounded-lg font-bold">
                        </div>
                        <div id="reporte-container" class="space-y-4"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL ALTA USUARIO -->
    <div id="modal-user" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl p-6 max-w-sm w-full shadow-2xl">
            <h3 class="text-xl font-black uppercase mb-4 italic">Alta de Suboficial</h3>
            <div class="space-y-4">
                <input type="text" id="new-dni" placeholder="DNI (COMO FIGURA EN CARNET)" class="w-full p-3 border-2 rounded-lg font-bold">
                <input type="text" id="new-nombre" placeholder="Nombre Completo" class="w-full p-3 border-2 rounded-lg font-bold uppercase">
                <input type="text" id="new-rango" placeholder="Rango / Grado" class="w-full p-3 border-2 rounded-lg font-bold uppercase">
                <div class="flex gap-2">
                    <button onclick="document.getElementById('modal-user').classList.add('hidden')" class="flex-1 bg-slate-100 py-3 rounded-xl font-black text-xs uppercase">Cancelar</button>
                    <button onclick="saveNewUser()" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-black text-xs uppercase">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL ALERTA -->
    <div id="modal-alerta" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50">
        <div id="alert-box" class="bg-white rounded-2xl p-8 max-w-sm w-full text-center shadow-2xl border-t-8">
            <h3 id="modal-titulo" class="text-xl font-black uppercase mb-2"></h3>
            <p id="modal-msg" class="text-slate-600 font-medium mb-6 text-sm"></p>
            <button onclick="document.getElementById('modal-alerta').classList.add('hidden')" class="w-full bg-slate-900 text-white py-3 rounded-xl font-black uppercase text-xs">Cerrar</button>
        </div>
    </div>

    <script>
        // CONFIGURACIÓN Y ESTADO
        let PRECIOS = JSON.parse(localStorage.getItem('mil_precios')) || { 'Desayuno': 5, 'Almuerzo': 10, 'Cena': 7 };
        let PADRON = JSON.parse(localStorage.getItem('mil_padron')) || [
            { dni: "60239", nombre: "SUBOFICIAL EJEMPLO", rango: "SARGENTO", saldo: 100.00 }
        ];
        let registros = JSON.parse(localStorage.getItem('mil_com_regs')) || [];
        let recargas = JSON.parse(localStorage.getItem('mil_com_recargas')) || [];
        
        let mealActual = 'Desayuno';
        let html5QrCode;
        let selectedFileBase64 = null;
        let lastScanned = null;
        let scanCooldown = false;

        function init() {
            document.getElementById('price-Desayuno').value = PRECIOS.Desayuno;
            document.getElementById('price-Almuerzo').value = PRECIOS.Almuerzo;
            document.getElementById('price-Cena').value = PRECIOS.Cena;
            document.getElementById('filter-date').valueAsDate = new Date();
            document.getElementById('label-fecha').innerText = new Date().toLocaleDateString();
            
            initScanner();
            renderAll();
        }

        function savePrices() {
            PRECIOS.Desayuno = parseFloat(document.getElementById('price-Desayuno').value) || 0;
            PRECIOS.Almuerzo = parseFloat(document.getElementById('price-Almuerzo').value) || 0;
            PRECIOS.Cena = parseFloat(document.getElementById('price-Cena').value) || 0;
            localStorage.setItem('mil_precios', JSON.stringify(PRECIOS));
        }

        // SCANNER MULTI-FORMATO (ADAPTADO A CARNETS)
        function initScanner() {
            // Se añaden formatos de códigos de barras industriales como PDF417 (común en carnets)
            const formatsToSupport = [
                Html5QrcodeSupportedFormats.QR_CODE,
                Html5QrcodeSupportedFormats.PDF417,
                Html5QrcodeSupportedFormats.CODE_128,
                Html5QrcodeSupportedFormats.CODE_39,
                Html5QrcodeSupportedFormats.EAN_13
            ];

            html5QrCode = new Html5Qrcode("reader");
            const config = { 
                fps: 15, 
                qrbox: { width: 300, height: 150 }, // Box alargado para códigos de barras de carnet
                aspectRatio: 1.0,
                formatsToSupport: formatsToSupport
            };

            html5QrCode.start(
                { facingMode: "environment" }, 
                config, 
                onScanSuccess
            ).catch(err => console.error("Error scanner:", err));
        }

        function onScanSuccess(decodedText) {
            if(scanCooldown || decodedText === lastScanned) return;
            
            // Limpiar el texto decodificado por si trae caracteres de control
            const cleanDni = decodedText.trim().toUpperCase();
            document.getElementById('dni-input').value = cleanDni;
            validarDNI(cleanDni);
            
            // Intentar procesar automáticamente si el suboficial existe
            const p = PADRON.find(p => p.dni === cleanDni);
            if(p) {
                procesarAcceso(cleanDni);
                activarCooldown();
            }
        }

        function activarCooldown() {
            scanCooldown = true;
            document.getElementById('reader').classList.add('scanner-active');
            setTimeout(() => {
                scanCooldown = false;
                document.getElementById('reader').classList.remove('scanner-active');
            }, 3000);
        }

        // LOGICA DE NEGOCIO
        function validarDNI(val) {
            const p = PADRON.find(p => p.dni === val.toUpperCase());
            const preview = document.getElementById('info-preview');
            if(p) {
                preview.classList.remove('hidden');
                document.getElementById('preview-nombre').innerText = p.nombre;
                document.getElementById('preview-rango').innerText = p.rango;
                document.getElementById('preview-saldo').innerText = `$${p.saldo.toFixed(2)}`;
                document.getElementById('preview-costo-actual').innerText = `$${PRECIOS[mealActual].toFixed(2)}`;
                document.getElementById('preview-saldo').className = p.saldo >= PRECIOS[mealActual] ? "text-sm font-black text-green-600" : "text-sm font-black text-red-600";
            } else {
                preview.classList.add('hidden');
            }
        }

        function procesarAcceso(dni) {
            const p = PADRON.find(p => p.dni === dni);
            const hoy = new Date().toLocaleDateString();
            const costo = PRECIOS[mealActual];

            if(!p) {
                customAlert("No Registrado", "El carnet no coincide con ningún suboficial en la base.", "red");
                return;
            }

            // Validar si ya comió hoy
            const yaComio = registros.find(r => r.dni === dni && r.fecha === hoy && r.servicio === mealActual && r.estado === 'AUTORIZADO');
            if(yaComio) { 
                customAlert("Ración Duplicada", `${p.nombre} ya consumió ${mealActual} hoy.`, "orange"); 
                registrarLog(p, 'DENEGADO (DUPLICADO)', 0);
                return; 
            }

            // Validar saldo
            if(p.saldo < costo) { 
                customAlert("Fondos Insuficientes", `Saldo: $${p.saldo.toFixed(2)}. Reclame carga de fondos.`, "red"); 
                registrarLog(p, 'DENEGADO (SIN SALDO)', 0);
                return; 
            }

            // Descontar y registrar
            p.saldo -= costo;
            localStorage.setItem('mil_padron', JSON.stringify(PADRON));
            registrarLog(p, 'AUTORIZADO', costo);
            
            document.getElementById('dni-input').value = "";
            document.getElementById('info-preview').classList.add('hidden');
            customAlert("Acceso Autorizado", `${p.rango} ${p.nombre} puede pasar.`, "green");
        }

        document.getElementById('registro-form').addEventListener('submit', (e) => {
            e.preventDefault();
            procesarAcceso(document.getElementById('dni-input').value.toUpperCase());
        });

        function registrarLog(p, estado, costo) {
            registros.push({
                dni: p.dni, nombre: p.nombre, rango: p.rango, estado, costo,
                servicio: mealActual,
                fecha: new Date().toLocaleDateString(),
                hora: new Date().toLocaleTimeString('es-ES', {hour12:false, hour:'2-digit', minute:'2-digit'})
            });
            localStorage.setItem('mil_com_regs', JSON.stringify(registros));
            renderAll();
        }

        // UI Y NAVEGACIÓN
        function setMeal(meal) {
            mealActual = meal;
            document.querySelectorAll('.meal-btn').forEach(btn => {
                btn.className = "meal-btn flex-1 py-2 rounded font-bold text-[10px] transition-all text-slate-500";
            });
            document.getElementById(`btn-${meal}`).className = "meal-btn flex-1 py-2 rounded font-bold text-[10px] transition-all bg-white shadow text-blue-700";
            validarDNI(document.getElementById('dni-input').value);
        }

        function switchTab(tab) {
            const tabs = ['control', 'recarga', 'personal', 'reportes'];
            tabs.forEach(t => {
                document.getElementById(`view-${t}`).classList.add('hidden');
                document.getElementById(`nav-${t}`).classList.replace('tab-active', 'tab-inactive');
            });
            document.getElementById(`view-${tab}`).classList.remove('hidden');
            document.getElementById(`nav-${tab}`).classList.replace('tab-inactive', 'tab-active');
            document.getElementById('side-control').classList.toggle('hidden', tab !== 'control');
            
            if(tab === 'personal') renderUserTable();
            if(tab === 'reportes') renderReporte();
        }

        function renderAll() {
            const hoy = new Date().toLocaleDateString();
            const tbody = document.getElementById('log-body');
            tbody.innerHTML = "";
            let stats = { Desayuno: 0, Almuerzo: 0, Rechazados: 0, Total: 0 };

            PADRON.forEach(p => stats.Total += p.saldo);

            registros.filter(r => r.fecha === hoy).reverse().forEach(r => {
                if(r.estado === 'AUTORIZADO') stats[r.servicio]++;
                else stats.Rechazados++;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="p-4 font-mono font-bold opacity-50 text-[10px]">${r.hora}</td>
                    <td class="p-4 uppercase"><b>${r.nombre}</b><br><span class="text-[8px] text-gray-400 font-bold">${r.rango}</span></td>
                    <td class="p-4 font-black text-slate-500 uppercase text-[9px]">${r.servicio}</td>
                    <td class="p-4 text-right font-black">$${(r.costo || 0).toFixed(2)}</td>
                    <td class="p-4 text-center">
                        <span class="px-2 py-1 rounded text-[8px] font-black uppercase ${r.estado === 'AUTORIZADO' ? 'bg-green-600 text-white' : 'bg-red-600 text-white'}">${r.estado}</span>
                    </td>
                `;
                tbody.appendChild(row);
            });

            document.getElementById('stat-desayuno').innerText = stats.Desayuno;
            document.getElementById('stat-almuerzo').innerText = stats.Almuerzo;
            document.getElementById('stat-rechazados').innerText = stats.Rechazados;
            document.getElementById('stat-total').innerText = `$${stats.Total.toFixed(2)}`;
        }

        // CARGA DE SALDO CON IMAGEN
        function handleFile(input) {
            const file = input.files[0];
            if (file) {
                document.getElementById('file-name').innerText = file.name;
                const reader = new FileReader();
                reader.onload = (e) => selectedFileBase64 = e.target.result;
                reader.readAsDataURL(file);
            }
        }

        function procesarRecarga() {
            const dni = document.getElementById('recarga-dni').value.toUpperCase();
            const monto = parseFloat(document.getElementById('recarga-monto').value);
            const p = PADRON.find(p => p.dni === dni);

            if(!p || isNaN(monto) || monto <= 0 || !selectedFileBase64) {
                customAlert("Error", "Complete todos los campos y adjunte el comprobante.", "red");
                return;
            }

            p.saldo += monto;
            localStorage.setItem('mil_padron', JSON.stringify(PADRON));
            
            recargas.push({
                dni, nombre: p.nombre, monto,
                fecha: new Date().toLocaleDateString(),
                hora: new Date().toLocaleTimeString(),
                imagen: selectedFileBase64
            });
            localStorage.setItem('mil_com_recargas', JSON.stringify(recargas));
            
            document.getElementById('recarga-dni').value = "";
            document.getElementById('recarga-monto').value = "";
            selectedFileBase64 = null;
            document.getElementById('file-name').innerText = "Subir Imagen";
            
            customAlert("Éxito", `Saldo acreditado a ${p.nombre}`, "green");
            renderAll();
        }

        // PERSONAL
        function renderUserTable() {
            const body = document.getElementById('user-table-body');
            body.innerHTML = PADRON.map(p => `
                <tr class="hover:bg-slate-50">
                    <td class="p-3 font-mono font-bold">${p.dni}</td>
                    <td class="p-3 font-black uppercase">${p.nombre}</td>
                    <td class="p-3 text-slate-500 font-bold">${p.rango}</td>
                    <td class="p-3 text-right font-black text-green-700">$${p.saldo.toFixed(2)}</td>
                    <td class="p-3"><button onclick="eliminarUser('${p.dni}')" class="text-red-500 font-bold uppercase text-[9px]">Eliminar</button></td>
                </tr>
            `).join('');
        }

        function saveNewUser() {
            const dni = document.getElementById('new-dni').value.toUpperCase();
            const nombre = document.getElementById('new-nombre').value.toUpperCase();
            const rango = document.getElementById('new-rango').value.toUpperCase();
            if(!dni || !nombre) return;
            PADRON.push({ dni, nombre, rango, saldo: 0 });
            localStorage.setItem('mil_padron', JSON.stringify(PADRON));
            document.getElementById('modal-user').classList.add('hidden');
            renderUserTable();
        }

        function eliminarUser(dni) {
            if(confirm("¿Eliminar de la base de datos?")) {
                PADRON = PADRON.filter(u => u.dni !== dni);
                localStorage.setItem('mil_padron', JSON.stringify(PADRON));
                renderUserTable();
            }
        }

        function renderReporte() {
            const dateStr = document.getElementById('filter-date').value;
            if(!dateStr) return;
            const target = new Date(dateStr + "T00:00:00").toLocaleDateString();
            const filtrados = registros.filter(r => r.fecha === target);
            const container = document.getElementById('reporte-container');
            
            if(filtrados.length === 0) {
                container.innerHTML = "<p class='text-center p-8 text-slate-400 font-bold'>Sin movimientos en esta fecha.</p>";
                return;
            }

            let total = 0;
            let html = `<div class='card p-4'><table class='w-full text-xs'><thead class='font-black uppercase text-[9px] border-b'><tr><th class='p-2'>Hora</th><th class='p-2'>Personal</th><th class='p-2'>Servicio</th><th class='p-2 text-right'>Costo</th></tr></thead><tbody>`;
            filtrados.forEach(r => {
                total += r.costo;
                html += `<tr><td class='p-2 font-mono'>${r.hora}</td><td class='p-2 font-bold'>${r.nombre}</td><td class='p-2'>${r.servicio}</td><td class='p-2 text-right font-bold'>$${r.costo.toFixed(2)}</td></tr>`;
            });
            html += `</tbody><tfoot class='border-t font-black'><tr><td colspan='3' class='p-2 text-right'>TOTAL DÍA:</td><td class='p-2 text-right'>$${total.toFixed(2)}</td></tr></tfoot></table></div>`;
            container.innerHTML = html;
        }

        function customAlert(titulo, msg, color) {
            const modal = document.getElementById('modal-alerta');
            const box = document.getElementById('alert-box');
            modal.classList.remove('hidden');
            const colorHex = color === 'red' ? '#dc2626' : (color === 'orange' ? '#ea580c' : '#16a34a');
            box.style.borderColor = colorHex;
            document.getElementById('modal-titulo').innerText = titulo;
            document.getElementById('modal-titulo').style.color = colorHex;
            document.getElementById('modal-msg').innerText = msg;
        }

        setInterval(() => {
            document.getElementById('current-time').innerText = new Date().toLocaleTimeString('es-ES', {hour12:false});
        }, 1000);

        window.onload = init;
    </script>
</body>
</html>
